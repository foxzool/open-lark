use open_lark_core::core::{
use serde_json;    constants::AccessTokenType, http::Transport,
    api_req::ApiRequest, api_resp::ApiResponseTrait, config::Config,
    constants::AccessTokenType, endpoints::EndpointBuilder, http::Transport,
};
use crate::contact::models::*;
use serde::{Deserialize, Serialize};

/// 部门管理服务
///
/// 提供完整的部门管理功能，包括：
/// - 创建、修改、删除部门
/// - 获取部门信息（单个/批量）
/// - 获取子部门列表
/// - 获取父部门信息
/// - 搜索部门
pub struct DepartmentService {
    config: Config,
}
impl DepartmentService {
    pub fn new(config: Config) -> Self {
        Self { config }
    }
    /// 获取客户端配置
    ///
    /// # 返回值
    /// 配置对象的引用
    pub fn config(&self) -> &Config {
        &self.config
    /// 创建部门
    /// 该接口用于创建新的部门。
    pub async fn create(
        &self,
        req: &CreateDepartmentRequest,
    ) -> open_lark_core::core::SDKResult<CreateDepartmentResponse> {
        let mut api_req = ApiRequest::default();
        api_req.set_http_method(reqwest::Method::POST);
        api_req.set_api_path(open_lark_core::core::endpoints::contact::CONTACT_V3_DEPARTMENTS.to_string());
        api_req.set_supported_access_token_types(vec![AccessTokenType::Tenant]);
        api_req.body = serde_json::to_vec(req)?;
        let resp =
            Transport::<CreateDepartmentResponse>::request(api_req, &self.config, None).await?;
        Ok(resp.data.unwrap_or_default())
    /// 修改部门部分信息
    /// 该接口用于修改部门的部分信息。
    pub async fn patch(
        department_id: &str,
        req: &PatchDepartmentRequest,
    ) -> open_lark_core::core::SDKResult<PatchDepartmentResponse> {
        api_req.set_http_method(reqwest::Method::PATCH);
        api_req.set_api_path(EndpointBuilder::replace_param(
            open_lark_core::core::endpoints::contact::CONTACT_V3_DEPARTMENT_GET,
            "department_id",
            department_id,
        ));
            Transport::<PatchDepartmentResponse>::request(api_req, &self.config, None).await?;
    /// 更新部门所有信息
    /// 该接口用于更新部门的所有信息。
    pub async fn update(
        req: &UpdateDepartmentRequest,
    ) -> open_lark_core::core::SDKResult<UpdateDepartmentResponse> {
        api_req.set_http_method(reqwest::Method::PUT);
            Transport::<UpdateDepartmentResponse>::request(api_req, &self.config, None).await?;
    /// 更新部门 ID
    /// 该接口用于更新部门的部门ID。
    pub async fn update_department_id(
        req: &UpdateDepartmentIdRequest,
    ) -> open_lark_core::core::SDKResult<UpdateDepartmentIdResponse> {
            open_lark_core::core::endpoints::contact::CONTACT_V3_DEPARTMENT_UPDATE_ID,
            Transport::<UpdateDepartmentIdResponse>::request(api_req, &self.config, None).await?;
    /// 获取单个部门信息
    /// 该接口用于获取单个部门的详细信息。
    pub async fn get(
        _req: &GetDepartmentRequest,
    ) -> open_lark_core::core::SDKResult<GetDepartmentResponse> {
        api_req.set_http_method(reqwest::Method::GET);
        api_req.set_supported_access_token_types(vec![AccessTokenType::Tenant, AccessTokenType::User]);
        api_req.body = Vec::new();
        api_req.query_params = std::collections::HashMap::new();
        let resp = Transport::<GetDepartmentResponse>::request(api_req, &self.config, None).await?;
    /// 批量获取部门信息
    pub async fn batch(
        req: &BatchGetDepartmentsRequest,
    ) -> open_lark_core::core::SDKResult<BatchGetDepartmentsResponse> {
        api_req.set_api_path(open_lark_core::core::endpoints::contact::CONTACT_V3_DEPARTMENTS_BATCH.to_string());
            Transport::<BatchGetDepartmentsResponse>::request(api_req, &self.config, None).await?;
    /// 获取子部门列表
    pub async fn children(
        _req: &GetChildrenDepartmentsRequest,
    ) -> open_lark_core::core::SDKResult<GetChildrenDepartmentsResponse> {
        api_req.set_api_path(open_lark_core::core::endpoints::contact::CONTACT_V3_DEPARTMENTS_CHILDREN.to_string());
            Transport::<GetChildrenDepartmentsResponse>::request(api_req, &self.config, None)
                .await?;
    /// 获取父部门信息
    pub async fn parent(
        _req: &GetParentDepartmentRequest,
    ) -> open_lark_core::core::SDKResult<GetParentDepartmentResponse> {
        api_req.set_api_path(open_lark_core::core::endpoints::contact::CONTACT_V3_DEPARTMENTS_PARENT.to_string());
            Transport::<GetParentDepartmentResponse>::request(api_req, &self.config, None).await?;
    /// 搜索部门
    pub async fn search(
        req: &SearchDepartmentsRequest,
    ) -> open_lark_core::core::SDKResult<SearchDepartmentsResponse> {
        api_req.set_api_path(open_lark_core::core::endpoints::contact::CONTACT_V3_DEPARTMENTS_SEARCH.to_string());
            Transport::<SearchDepartmentsResponse>::request(api_req, &self.config, None).await?;
    /// 删除部门
    pub async fn delete(
        _req: &DeleteDepartmentRequest,
    ) -> open_lark_core::core::SDKResult<DeleteDepartmentResponse> {
        api_req.set_http_method(reqwest::Method::DELETE);
            Transport::<DeleteDepartmentResponse>::request(api_req, &self.config, None).await?;
// 请求/响应结构体定义
/// 创建部门请求
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CreateDepartmentRequest {
    /// 部门信息
    pub department: Department,
    /// 用户 ID 类型
    #[serde(skip_serializing_if = "Option::is_none")]
    pub user_id_type: Option<String>,
    /// 部门 ID 类型
    pub department_id_type: Option<String>,
    /// 客户端令牌
    pub client_token: Option<String>,
/// 创建部门响应
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct CreateDepartmentResponse {
impl ApiResponseTrait for CreateDepartmentResponse {
    fn data_format() -> open_lark_core::core::api_resp::ResponseFormat {
        open_lark_core::core::api_resp::ResponseFormat::Data
/// 修改部门请求
pub struct PatchDepartmentRequest {
/// 修改部门响应
pub struct PatchDepartmentResponse {
impl ApiResponseTrait for PatchDepartmentResponse {
/// 更新部门请求
pub struct UpdateDepartmentRequest {
/// 更新部门响应
pub struct UpdateDepartmentResponse {
impl ApiResponseTrait for UpdateDepartmentResponse {
/// 更新部门ID请求
pub struct UpdateDepartmentIdRequest {
    /// 新的部门ID
    pub new_department_id: String,
/// 更新部门ID响应
pub struct UpdateDepartmentIdResponse {}
impl ApiResponseTrait for UpdateDepartmentIdResponse {
/// 获取部门请求
#[derive(Debug, Clone, Default, Serialize, Deserialize)]
pub struct GetDepartmentRequest {
/// 获取部门响应
pub struct GetDepartmentResponse {
impl ApiResponseTrait for GetDepartmentResponse {
/// 批量获取部门请求
pub struct BatchGetDepartmentsRequest {
    /// 部门ID列表
    pub department_ids: Vec<String>,
/// 批量获取部门响应
pub struct BatchGetDepartmentsResponse {
    /// 部门列表
    pub items: Vec<Department>,
impl ApiResponseTrait for BatchGetDepartmentsResponse {
/// 获取子部门列表请求
pub struct GetChildrenDepartmentsRequest {
    /// 父部门ID
    pub parent_department_id: Option<String>,
    /// 是否递归获取
    pub fetch_child: Option<bool>,
    /// 分页大小
    pub page_size: Option<i32>,
    /// 分页标记
    pub page_token: Option<String>,
/// 获取子部门列表响应
pub struct GetChildrenDepartmentsResponse {
    /// 是否还有更多项目
    pub has_more: Option<bool>,
impl ApiResponseTrait for GetChildrenDepartmentsResponse {
/// 获取父部门请求
pub struct GetParentDepartmentRequest {
    /// 部门ID
    pub department_id: Option<String>,
/// 获取父部门响应
pub struct GetParentDepartmentResponse {
impl ApiResponseTrait for GetParentDepartmentResponse {
/// 搜索部门请求
pub struct SearchDepartmentsRequest {
    /// 搜索关键词
    pub query: String,
/// 搜索部门响应
pub struct SearchDepartmentsResponse {
impl ApiResponseTrait for SearchDepartmentsResponse {
/// 删除部门请求
pub struct DeleteDepartmentRequest {
/// 删除部门响应
pub struct DeleteDepartmentResponse {}
impl ApiResponseTrait for DeleteDepartmentResponse {
#[cfg(test)]
mod tests {
    use super::*;
    use open_lark_core::core::config::Config;
    use crate::contact::models::Department;
    #[test]
    fn test_department_service_creation() {
        let config = Config::default();
        let service = DepartmentService::new(config.clone());
        assert_eq!(service.config.app_id, config.app_id);
        assert_eq!(service.config.app_secret, config.app_secret);
    fn test_department_service_with_custom_config() {
        let config = Config::builder()
            .app_id("dept_test_app")
            .app_secret("dept_test_secret")
            .build();
        assert_eq!(service.config.app_id, "dept_test_app");
        assert_eq!(service.config.app_secret, "dept_test_secret");
    fn test_create_department_request_construction() {
        let department = Department {
            department_id: Some("dept_123".to_string()),
            name: Some("Engineering".to_string()),
            ..Default::default()
        };
        let request = CreateDepartmentRequest {
            department,
            user_id_type: Some("user_id".to_string()),
            department_id_type: Some("open_id".to_string()),
            client_token: Some("token_123".to_string()),
        assert_eq!(
            request.department.department_id,
            Some("dept_123".to_string())
        );
        assert_eq!(request.department.name, Some("Engineering".to_string()));
        assert_eq!(request.user_id_type, Some("user_id".to_string()));
        assert_eq!(request.department_id_type, Some("open_id".to_string()));
        assert_eq!(request.client_token, Some("token_123".to_string()));
    fn test_create_department_request_with_none_values() {
            name: Some("HR".to_string()),
            user_id_type: None,
            department_id_type: None,
            client_token: None,
        assert_eq!(request.department.name, Some("HR".to_string()));
        assert_eq!(request.user_id_type, None);
        assert_eq!(request.department_id_type, None);
        assert_eq!(request.client_token, None);
    fn test_patch_department_request_construction() {
            department_id: Some("dept_456".to_string()),
            name: Some("Marketing".to_string()),
        let request = PatchDepartmentRequest {
            user_id_type: Some("union_id".to_string()),
            department_id_type: Some("department_id".to_string()),
            Some("dept_456".to_string())
        assert_eq!(request.department.name, Some("Marketing".to_string()));
        assert_eq!(request.user_id_type, Some("union_id".to_string()));
            request.department_id_type,
            Some("department_id".to_string())
    fn test_update_department_request_construction() {
            department_id: Some("dept_789".to_string()),
            name: Some("Sales".to_string()),
        let request = UpdateDepartmentRequest {
            user_id_type: Some("open_id".to_string()),
            Some("dept_789".to_string())
        assert_eq!(request.department.name, Some("Sales".to_string()));
        assert_eq!(request.user_id_type, Some("open_id".to_string()));
    fn test_update_department_id_request_construction() {
        let request = UpdateDepartmentIdRequest {
            new_department_id: "new_dept_id_123".to_string(),
        assert_eq!(request.new_department_id, "new_dept_id_123");
    fn test_update_department_id_request_with_none_type() {
            new_department_id: "new_dept_id_456".to_string(),
        assert_eq!(request.new_department_id, "new_dept_id_456");
    fn test_get_department_request_construction() {
        let request = GetDepartmentRequest {
    fn test_get_department_request_default() {
        let request = GetDepartmentRequest::default();
    fn test_batch_get_departments_request_construction() {
        let request = BatchGetDepartmentsRequest {
            department_ids: vec![
                "dept_1".to_string(),
                "dept_2".to_string(),
                "dept_3".to_string(),
            ],
        assert_eq!(request.department_ids.len(), 3);
        assert_eq!(request.department_ids[0], "dept_1");
        assert_eq!(request.department_ids[2], "dept_3");
    fn test_batch_get_departments_request_with_empty_list() {
            department_ids: vec![],
        assert!(request.department_ids.is_empty());
    fn test_get_children_departments_request_construction() {
        let request = GetChildrenDepartmentsRequest {
            parent_department_id: Some("parent_dept_123".to_string()),
            fetch_child: Some(true),
            page_size: Some(50),
            page_token: Some("page_token_123".to_string()),
            request.parent_department_id,
            Some("parent_dept_123".to_string())
        assert_eq!(request.fetch_child, Some(true));
        assert_eq!(request.page_size, Some(50));
        assert_eq!(request.page_token, Some("page_token_123".to_string()));
    fn test_get_children_departments_request_default() {
        let request = GetChildrenDepartmentsRequest::default();
        assert_eq!(request.parent_department_id, None);
        assert_eq!(request.fetch_child, None);
        assert_eq!(request.page_size, None);
        assert_eq!(request.page_token, None);
    fn test_get_parent_department_request_construction() {
        let request = GetParentDepartmentRequest {
        assert_eq!(request.department_id, Some("dept_456".to_string()));
    fn test_get_parent_department_request_default() {
        let request = GetParentDepartmentRequest::default();
        assert_eq!(request.department_id, None);
    fn test_search_departments_request_construction() {
        let request = SearchDepartmentsRequest {
            query: "Engineering".to_string(),
            page_size: Some(20),
            page_token: Some("search_token_123".to_string()),
        assert_eq!(request.query, "Engineering");
        assert_eq!(request.page_size, Some(20));
        assert_eq!(request.page_token, Some("search_token_123".to_string()));
    fn test_search_departments_request_with_minimal_data() {
            query: "HR".to_string(),
            page_size: None,
            page_token: None,
        assert_eq!(request.query, "HR");
    fn test_delete_department_request_construction() {
        let request = DeleteDepartmentRequest {
    fn test_delete_department_request_default() {
        let request = DeleteDepartmentRequest::default();
    fn test_create_department_response_default() {
        let response = CreateDepartmentResponse::default();
        assert_eq!(response.department.name, None);
        assert_eq!(response.department.department_id, None);
    fn test_patch_department_response_default() {
        let response = PatchDepartmentResponse::default();
    fn test_update_department_response_default() {
        let response = UpdateDepartmentResponse::default();
    fn test_update_department_id_response_default() {
        let _response = UpdateDepartmentIdResponse::default();
        // UpdateDepartmentIdResponse is an empty struct, just test it can be created
    fn test_get_department_response_default() {
        let response = GetDepartmentResponse::default();
    fn test_batch_get_departments_response_default() {
        let response = BatchGetDepartmentsResponse::default();
        assert!(response.items.is_empty());
    fn test_get_children_departments_response_default() {
        let response = GetChildrenDepartmentsResponse::default();
        assert_eq!(response.has_more, None);
        assert_eq!(response.page_token, None);
    fn test_get_parent_department_response_default() {
        let response = GetParentDepartmentResponse::default();
    fn test_search_departments_response_default() {
        let response = SearchDepartmentsResponse::default();
    fn test_delete_department_response_default() {
        let _response = DeleteDepartmentResponse::default();
        // DeleteDepartmentResponse is an empty struct, just test it can be created
    fn test_request_structs_debug_trait() {
            name: Some("Debug Test Dept".to_string()),
        let create_request = CreateDepartmentRequest {
            department: department.clone(),
        let debug_str = format!("{:?}", create_request);
        assert!(debug_str.contains("CreateDepartmentRequest"));
        assert!(debug_str.contains("Debug Test Dept"));
    fn test_search_departments_request_edge_cases() {
        // Test with very long query string
        let long_query = "a".repeat(1000);
        let request_long = SearchDepartmentsRequest {
            query: long_query.clone(),
            page_size: Some(100),
        assert_eq!(request_long.query, long_query);
        assert_eq!(request_long.page_size, Some(100));
        // Test with zero page size
        let request_zero = SearchDepartmentsRequest {
            query: "Test".to_string(),
            page_size: Some(0),
        assert_eq!(request_zero.page_size, Some(0));
        // Test with empty query
        let request_empty = SearchDepartmentsRequest {
            query: "".to_string(),
            page_size: Some(10),
        assert_eq!(request_empty.query, "");
    fn test_batch_get_departments_request_edge_cases() {
        // Test with very large department ID list
        let large_list: Vec<String> = (0..1000).map(|i| format!("dept_{}", i)).collect();
        let request_large = BatchGetDepartmentsRequest {
            department_ids: large_list.clone(),
        assert_eq!(request_large.department_ids.len(), 1000);
        assert_eq!(request_large.department_ids[999], "dept_999");
        // Test with single department ID
        let request_single = BatchGetDepartmentsRequest {
            department_ids: vec!["single_dept".to_string()],
        assert_eq!(request_single.department_ids.len(), 1);
        assert_eq!(request_single.department_ids[0], "single_dept");
    fn test_get_children_departments_request_edge_cases() {
        // Test with very large page size
        let request_large_page = GetChildrenDepartmentsRequest {
            parent_department_id: Some("parent_123".to_string()),
            page_size: Some(10000),
        assert_eq!(request_large_page.page_size, Some(10000));
        assert_eq!(request_large_page.fetch_child, Some(true));
        // Test with fetch_child set to false
        let request_no_fetch = GetChildrenDepartmentsRequest {
            parent_department_id: None,
            fetch_child: Some(false),
        assert_eq!(request_no_fetch.fetch_child, Some(false));
        assert_eq!(request_no_fetch.parent_department_id, None);
    fn test_department_service_config_independence() {
        let config1 = Config::builder().app_id("dept_app_1").build();
        let config2 = Config::builder().app_id("dept_app_2").build();
        let service1 = DepartmentService::new(config1);
        let service2 = DepartmentService::new(config2);
        assert_eq!(service1.config.app_id, "dept_app_1");
        assert_eq!(service2.config.app_id, "dept_app_2");
        assert_ne!(service1.config.app_id, service2.config.app_id);
    fn test_api_response_trait_implementations() {
        // Test that all response types implement ApiResponseTrait correctly
            CreateDepartmentResponse::data_format(),
            open_lark_core::core::api_resp::ResponseFormat::Data
            PatchDepartmentResponse::data_format(),
            UpdateDepartmentResponse::data_format(),
            UpdateDepartmentIdResponse::data_format(),
            GetDepartmentResponse::data_format(),
            BatchGetDepartmentsResponse::data_format(),
            GetChildrenDepartmentsResponse::data_format(),
            GetParentDepartmentResponse::data_format(),
            SearchDepartmentsResponse::data_format(),
            DeleteDepartmentResponse::data_format(),
