name: Coverage

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_TOOLCHAIN: stable
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
  # 必须禁用增量编译才能正确收集覆盖率数据
  CARGO_INCREMENTAL: "0"
  MIN_COVERAGE: "40.0"

jobs:
  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.CARGO_TOOLCHAIN }}
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Show cargo-llvm-cov version
        run: cargo llvm-cov --version

      # 注意：rust-cache 与覆盖率收集不兼容，禁用缓存
      # - uses: Swatinem/rust-cache@v2
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: 23.4
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run coverage tests
        run: |
          set -euo pipefail
          cargo llvm-cov clean --workspace
          mkdir -p target/llvm-cov
          # 使用 --lib --tests 代替 --all-targets 以避免编译示例和基准
          # 这样可以减少编译时间和内存使用，避免 LLVM 工具链崩溃
          # 先运行测试收集覆盖率数据
          cargo llvm-cov --workspace --all-features --lib --tests || {
            echo "Tests failed" >&2
            exit 1
          }
      - name: Diagnose coverage generation
        if: failure()
        run: |
          echo "=== Checking LLVM tools ==="
          llvm-cov --version || echo "llvm-cov not found"
          llvm-profdata --version || echo "llvm-profdata not found"
          echo ""
          echo "=== Checking target directory ==="
          ls -la target/llvm-cov/ || echo "target/llvm-cov not found"
          echo ""
          echo "=== Checking for .profraw files ==="
          find target -name '*.profraw' -type f | head -20 || echo "No .profraw files found"
          echo ""
          echo "=== Cargo version ==="
          cargo --version
          rustc --version
      - name: Collect coverage summary
        id: coverage
        run: |
          set -euo pipefail
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # 生成 JSON 摘要
          cargo llvm-cov report --workspace --all-features --json --summary-only --output-path target/llvm-cov/summary.json

          cov=$(python3 -c 'import json; d=json.load(open("target/llvm-cov/summary.json","r",encoding="utf-8")); print("{:.2f}".format(d["data"][0]["totals"]["lines"]["percent"]))')

          if [ -z "$cov" ]; then
            echo "Failed to parse coverage result" >&2
            exit 1
          fi

          printf 'Line coverage: %s%%\n' "$cov" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "value=$cov" >> $GITHUB_OUTPUT

      - name: Generate LCOV report
        run: |
          cargo llvm-cov report --workspace --all-features --lcov --output-path target/llvm-cov/lcov.info

      - name: Generate HTML report
        run: |
          cargo llvm-cov report --workspace --all-features --html --output-dir target/llvm-cov/html
      # 注意：Codecov 上传需要 CODECOV_TOKEN，暂时禁用
      # - name: Upload coverage to Codecov
      #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      #   continue-on-error: true
      #   uses: codecov/codecov-action@v4
      #   with:
      #     files: target/llvm-cov/lcov.info
      #     flags: unittests
      #     name: codecov-umbrella
      #     fail_ci_if_error: false

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: target/llvm-cov/html/
          retention-days: 30

      - name: Enforce coverage threshold on main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cov=${{ steps.coverage.outputs.value }}
          awk -v cov="$cov" -v min="$MIN_COVERAGE" 'BEGIN { if (cov+0 < min+0) { printf("Coverage %.2f%% < threshold %.2f%%\n", cov, min); exit 1 } else { printf("Coverage %.2f%% >= threshold %.2f%%\n", cov, min); } }'

      - name: Report coverage threshold (PR)
        if: github.event_name == 'pull_request'
        run: |
          cov=${{ steps.coverage.outputs.value }}
          printf 'Pull request coverage: %s%% (threshold %s%%, informational only)\n' "$cov" "$MIN_COVERAGE"
