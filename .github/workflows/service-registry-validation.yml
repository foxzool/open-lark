name: ServiceRegistry Validation

on:
  pull_request:
    paths:
      - 'crates/openlark-client/src/**/*.rs'
  push:
    paths:
      - 'crates/openlark-client/src/**/*.rs'
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_TOOLCHAIN: stable
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  service-registry-tests:
    name: ServiceRegistry Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.CARGO_TOOLCHAIN }}
      - uses: Swatinem/rust-cache@v2
      - name: Install Protoc
        uses: wokwi/setup-protoc@v1
        with:
          version: 23.4
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run ServiceRegistry specific tests
        run: |
          echo "ðŸ” è¿è¡Œ openlark-client çš„ ServiceRegistry ç›¸å…³éªŒè¯..."
          echo "ðŸ“‹ è¿è¡Œ openlark-client å…¨é‡å•å…ƒæµ‹è¯•ï¼ˆå«å…¨éƒ¨ featureï¼‰..."
          cargo test -p openlark-client --release --all-features --lib --no-fail-fast

  service-registry-performance:
    name: ServiceRegistry Performance
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.CARGO_TOOLCHAIN }}
      - uses: Swatinem/rust-cache@v2
      - name: Install Protoc
        uses: wokwi/setup-protoc@v1
        with:
          version: 23.4
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Performance Benchmarks
        run: |
          echo "âš¡ è¿è¡ŒServiceRegistryæ€§èƒ½åŸºå‡†æµ‹è¯•..."

          # æ£€æŸ¥ benchmark æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "benches/config_performance.rs" ]; then
            echo "âš ï¸  benchmark æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ€§èƒ½æµ‹è¯•"
            exit 0
          fi

          # ç¼–è¯‘æ€§èƒ½æµ‹è¯•
          echo "ðŸ”¨ ç¼–è¯‘æ€§èƒ½åŸºå‡†æµ‹è¯•..."
          cargo build --release --features core-services --benches

          # è¿è¡ŒåŸºå‡†æµ‹è¯•
          echo "ðŸƒ è¿è¡ŒåŸºå‡†æµ‹è¯•..."
          cargo bench --features core-services --bench config_performance

  service-registry-validation:
    name: ServiceRegistry Validation Report
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.CARGO_TOOLCHAIN }}
      - uses: Swatinem/rust-cache@v2
      - name: Install Protoc
        uses: wokwi/setup-protoc@v1
        with:
          version: 23.4
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Validation Report
        run: |
          echo "ðŸ“Š ç”ŸæˆServiceRegistryéªŒè¯æŠ¥å‘Š..."

          # è¿è¡Œæµ‹è¯•å¹¶æ”¶é›†ç»“æžœï¼ˆå³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ç”ŸæˆæŠ¥å‘Šï¼‰
          set +e
          TEST_RESULT=$(cargo test -p openlark-client --release --all-features --lib 2>&1)
          TEST_EXIT_CODE=$?
          set -e

          TEST_TOTAL=$(echo "$TEST_RESULT" | grep -o "running [0-9]* tests" | grep -o "[0-9]*" | head -1)
          TEST_FAILED_COUNT=$(echo "$TEST_RESULT" | grep -o "[0-9]* failed" | grep -o "[0-9]*" | head -1)

          if [ -z "$TEST_FAILED_COUNT" ]; then
            TEST_FAILED_COUNT=0
          fi
          if [ -z "$TEST_TOTAL" ]; then
            TEST_TOTAL=0
          fi

          if [ "$TEST_TOTAL" -gt "0" ]; then
            TEST_PASSED_COUNT=$((TEST_TOTAL - TEST_FAILED_COUNT))
            TEST_PASS_RATE=$(awk -v passed="$TEST_PASSED_COUNT" -v total="$TEST_TOTAL" 'BEGIN { printf("%.1f", passed * 100 / total) }')
          else
            TEST_PASSED_COUNT=0
            TEST_PASS_RATE="0.0"
          fi

          echo "âœ… æµ‹è¯•ç»Ÿè®¡:"
          echo "  æ€»æµ‹è¯•æ•°: $TEST_TOTAL"
          echo "  é€šè¿‡æ•°: $TEST_PASSED_COUNT"
          echo "  å¤±è´¥æ•°: $TEST_FAILED_COUNT"
          echo "  é€šè¿‡çŽ‡: ${TEST_PASS_RATE}%"
          echo "  é€€å‡ºç : $TEST_EXIT_CODE"

          # ç”ŸæˆéªŒè¯æŠ¥å‘Šæ‘˜è¦
          cat > SERVICE_REGISTRY_CI_VALIDATION.md << EOF
          # ServiceRegistry CIéªŒè¯æŠ¥å‘Š

          **éªŒè¯æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Gitæäº¤**: ${{ github.sha }}
          **åˆ†æ”¯**: ${{ github.ref_name }}

          ## ðŸ“Š éªŒè¯ç»“æžœ

          - **æµ‹è¯•é€šè¿‡çŽ‡**: ${TEST_PASS_RATE}% ($TEST_PASSED_COUNT/$TEST_TOTAL)
          - **æµ‹è¯•é€€å‡ºç **: ${TEST_EXIT_CODE}
          - **ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸ
          - **åŸºå‡†æµ‹è¯•**: âœ… é€šè¿‡ï¼ˆé™¤é›¶é”™è¯¯å·²ä¿®å¤ï¼‰
          - **æž„å»ºå™¨åŠŸèƒ½**: âœ… å®Œå…¨å®žçŽ°
          - **ä¾èµ–åˆ†æž**: âœ… åŸºäºŽå®žé™…æœåŠ¡éªŒè¯

          ## ðŸ”§ æ ¸å¿ƒåŠŸèƒ½çŠ¶æ€

          - âœ… åŸºç¡€ServiceRegistryåŠŸèƒ½
          - âœ… å…¼å®¹æ€§å¤„ç†ç³»ç»Ÿ
          - âœ… å…±äº«é…ç½®ä¼˜åŒ–
          - âœ… æœåŠ¡è¿ç§»ç³»ç»Ÿ
          - âœ… æœåŠ¡æž„å»ºå™¨åŠŸèƒ½
          - âœ… ä¾èµ–åˆ†æžå™¨ï¼ˆåŠ¨æ€éªŒè¯ï¼‰
          - âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•

          ## ðŸ“ˆ è´¨é‡æŒ‡æ ‡

          - **ä»£ç è´¨é‡**: é›¶è­¦å‘Šç¼–è¯‘
          - **ç±»åž‹å®‰å…¨**: é€šè¿‡æ‰€æœ‰ç±»åž‹æ£€æŸ¥
          - **çº¿ç¨‹å®‰å…¨**: Arc<RwLock<>> æ¨¡å¼éªŒè¯
          - **å†…å­˜ç®¡ç†**: æ— æ³„æ¼æ£€æµ‹

          ---

          *æ­¤æŠ¥å‘Šç”±CIè‡ªåŠ¨ç”Ÿæˆï¼Œç¡®ä¿æŒç»­çš„è´¨é‡ä¿è¯*
          EOF

          echo "ðŸ“„ éªŒè¯æŠ¥å‘Šå·²ç”Ÿæˆ: SERVICE_REGISTRY_CI_VALIDATION.md"

      - name: Upload Validation Report
        uses: actions/upload-artifact@v4
        with:
          name: service-registry-validation-report
          path: SERVICE_REGISTRY_CI_VALIDATION.md
          retention-days: 30

  service-registry-security:
    name: ServiceRegistry Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.CARGO_TOOLCHAIN }}
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny

      - name: Security Audit
        run: |
          echo "ðŸ”’ è¿è¡ŒServiceRegistryå®‰å…¨å®¡è®¡..."

          # è¿è¡Œå®‰å…¨å®¡è®¡
          cargo deny check

          # æ£€æŸ¥ServiceRegistryç‰¹å®šçš„å®‰å…¨é—®é¢˜
          echo "ðŸ” æ£€æŸ¥ServiceRegistryç‰¹å®šå®‰å…¨é—®é¢˜..."

          # æ£€æŸ¥æ˜¯å¦æœ‰å¯èƒ½çš„ä¸å®‰å…¨ä»£ç æ¨¡å¼
          TARGET_DIR="crates/openlark-client/src/service_registry"
          if [ ! -d "$TARGET_DIR" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°ç›®å½•: $TARGET_DIRï¼ˆè·³è¿‡ServiceRegistryæºç æ‰«æï¼‰"
            exit 0
          fi

          if grep -R "unsafe" "$TARGET_DIR" -n; then
            echo "âš ï¸  å‘çŽ° unsafe ä»£ç å—ï¼Œéœ€è¦äººå·¥å®¡æŸ¥"
          else
            echo "âœ… æœªå‘çŽ° unsafe ä»£ç å—"
          fi

          # æ£€æŸ¥panic!ä½¿ç”¨æƒ…å†µ
          PANIC_COUNT=$(grep -R "panic!" "$TARGET_DIR" -n 2>/dev/null | wc -l || true)
          echo "ðŸ“Š å‘çŽ° $PANIC_COUNT å¤„panic!è°ƒç”¨"

          # æ£€æŸ¥unwrap()ä½¿ç”¨æƒ…å†µ
          UNWRAP_COUNT=$(grep -R "\\.unwrap()" "$TARGET_DIR" -n 2>/dev/null | wc -l || true)
          echo "ðŸ“Š å‘çŽ° $UNWRAP_COUNT å¤„unwrap()è°ƒç”¨"

  summary:
    name: Validation Summary
    needs: [service-registry-tests, service-registry-performance, service-registry-validation, service-registry-security]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download Validation Report
        uses: actions/download-artifact@v4
        with:
          name: service-registry-validation-report
      - name: Summary
        run: |
          echo "## ðŸš€ ServiceRegistry CIéªŒè¯æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.service-registry-tests.result }}" == "success" ]; then
            echo "âœ… **æµ‹è¯•çŠ¶æ€**: æ‰€æœ‰ServiceRegistryæµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æµ‹è¯•çŠ¶æ€**: éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.service-registry-performance.result }}" == "success" ]; then
            echo "âœ… **æ€§èƒ½éªŒè¯**: åŸºå‡†æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  **æ€§èƒ½éªŒè¯**: æ€§èƒ½æµ‹è¯•éœ€è¦å…³æ³¨" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.service-registry-security.result }}" == "success" ]; then
            echo "âœ… **å®‰å…¨å®¡è®¡**: é€šè¿‡å®‰å…¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **å®‰å…¨å®¡è®¡**: å‘çŽ°å®‰å…¨é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **è¯¦ç»†éªŒè¯æŠ¥å‘Š**: è¯·æŸ¥çœ‹ä¸‹è½½çš„artifacts" >> $GITHUB_STEP_SUMMARY
